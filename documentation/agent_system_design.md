# Agent System Design

Этот документ описывает целевую архитектуру многоинструментального RAG-агента для финансовых и налоговых документов. Он дополняет `documentation/rag_agent_design.md`, подробно раскрывая сценарии маршрутизации, интеграции с Qdrant и внешними API, а также требования к функциям, которые LLM должен вызывать в каждом шаге.

## 1. Цели и ограничения
- Единый агент, способный отвечать на вопросы по пользовательским документам, внутренней базе знаний и внешним источникам (ЦБ РФ, Tavily).
- Безопасный доступ к данным: векторы и поиски фильтруются по `user_id`, прямой доступ к чужим документам исключён.
- Максимальный контекст, который можно передать в LLM напрямую, ограничен `50 000` символами (см. `RagAgent._max_context_chars`).
- Агент работает в асинхронном FastAPI-приложении; все сетевые вызовы (OpenRouter, Qdrant, ЦБ, Tavily) выполняются через awaitable-клиенты.

## 2. Построение на существующих компонентах
- `services/rag/agent.py` — основной оркестратор (сценарии, query expansion, генерация).
- `services/document_processing/vector_manager.py` + `services/qdrant/vector_store.py` — загрузка/поиск в Qdrant.
- `services/document_service.search_document_chunks` — внутренняя функция для поиска чанков пользователя.
- `knowledge_base/train_data.csv` — исходник для корпоративной базы знаний (планируется конвертация в markdown-чанки и индексация в отдельную коллекцию).
- `services/rag/prompt_storage/*.txt` — системные/оркестраторные/фьюжн-промпты.

Новая логика должна расширять `RagAgent` (или его будущего наследника), не нарушая публичный API `run(...)`.

## 3. Инвентарь функций (tools) для LLM
| Функция | Назначение | Вход | Выход |
| --- | --- | --- | --- |
| `search_user_documents` | Поиск чанков в документах пользователя через Qdrant | `query`, `top_k`, `score_threshold`, `document_ids?` | список `VectorSearchResult` |
| `load_documents_full` | Получение полного текста выбранных документов | `document_ids` | массив `{document_id, title, content}` |
| `search_general_kb` | RAG по внутренней MD-базе (отдельная коллекция Qdrant либо FAISS) | `query`, `top_k`, `filters?` | список чанков + ссылки на источники |
| `fetch_cbr_data` | Чтение курсов/ключевой ставки из SOAP API ЦБ РФ | `mode` (`"currency"|"key_rate"|"news"`), параметры (`date`, `code`) | нормализованный JSON (значение, дата публикации, источник) |
| `fetch_finance_news` | Tavily web-search с параметрами для финансовых новостей | `query`, `max_results`, `search_depth` | список `{title, url, snippet, published_at}` |
| `generate_answer` | Вызов OpenRouter Chat с собранным контекстом и инструкциями | `messages`, `context`, `scenario_meta` | текст ответа + debug |

Функции будут зарегистрированы в массиве `tools` клиента OpenRouter; агент выбирает их через `tool_choice="auto"`, а сервер обрабатывает `tool_calls`, исполняя соответствующие Python-обработчики.

## 4. Сценарии маршрутизации

| Сценарий | Условия детектора | Действия |
| --- | --- | --- |
| **S1. Поиск по документам** | Нет выбранных документов, текст запроса содержит слова-триггеры поиска («найди», «какой договор», «покажи файл» и т.п.) | Запускаем RAG по всем документам пользователя (`search_user_documents`). |
| **S2. Общие вопросы без документов** | Нет выбранных документов и вопрос не требует поиска файла | Ветвление по подтипа: <br>• термины/регламент → `search_general_kb`; <br>• курсы/ключевая ставка → `fetch_cbr_data`; <br>• новости → `fetch_finance_news`. |
| **S3. Документы выбраны (<50k символов)** | Пользователь приложил ≤N документов, суммарный размер ≤ 50 000 символов | Полностью подгружаем документы (`load_documents_full`) и отправляем в LLM без векторного поиска. |
| **S4. Документы выбраны (≥50k символов)** | Есть выбранные документы, но суммарный размер велик | Выполняем таргетированный RAG по их `document_id` с query expansion и RRF. |
| **S5. Уточнение** | Детектор не уверен или запрос недостаточно конкретен | LLM задаёт уточняющие вопросы на основе шаблона `clarifications`. |

Текущий `RagAgent._choose_scenario` уже возвращает код 1–4. Для нового поведения:  
- добавляем классификатор подтипов внутри сценария 2 (терминология / курсы / новости / small talk).  
- расширяем JSON ответа оркестратора полем `intent`, чтобы не перегружать правила.  
- правило fallback остаётся как сейчас (`rule_guess_scenario`).

## 5. Потоки выполнения

### 5.1. Общий скелет `run`
1. Подгрузить историю (`MessageRepository.get_last_for_chat`).  
2. Получить решение оркестратора (LLM + правила).  
3. В зависимости от сценария вызвать соответствующий обработчик: `answer_with_full_context`, `answer_with_chunks`, `answer_general`, `ask_clarification`.  
4. Собрать `AgentResult` (ответ + использованные чанки + debug).

### 5.2. Сценарий 1 — поиск по всем документам
1. Проверяем кэш результатов (опционально).  
2. Если `use_query_expansion` истинно, вызвать `_expand_query` → сформировать подзапросы.  
3. Вызвать `search_user_documents` (который уже маппится на `search_document_chunks` / Qdrant) для каждого подзапроса.  
4. Слить результаты RRF (`_rrf_merge`).  
5. Передать лучшие чанки в `answer_with_chunks`.

### 5.3. Сценарий 2 — общие вопросы
Подпроцедура `route_general_intent` принимает `query`, `history`, `decision.intent` и возвращает один из подрежимов:
- **Термины / нормативка**: `search_general_kb` (коллекция `kb_chunks`). Используем такой же пайплайн, как для документов, но с общим `user_id=0` и тегом источника.  
- **Курсы валют / ключевая ставка**:  
  - Курсы — если вопрос содержит ISO-коды валют, триггеры («курс евро», «USD/RUB»). Вызвать SOAP `GetCursOnDate` или `GetCursDynamic` с нужной датой.^([ЦБ API](https://cbr.ru/DailyInfoWebServ/DailyInfo.asmx))  
  - Ключевая ставка — вызов `KeyRate`. Результат нормализуется к `{"value": 0.16, "date": "2024-09-15"}` и передаётся в контекст.  
- **Финансовые новости**: сформировать поисковый запрос (LLM может сгенерировать уточнённые ключи) и вызвать Tavily `POST /search` с флагами `topic: "finance"`, `max_results` 3–5, `search_depth: "advanced"`.^([Tavily API](https://docs.tavily.com/documentation/api-reference/endpoint/search))  
- **Small talk**: fallback на `answer_general` (без внешних вызовов).

### 5.4. Сценарий 3 — полный контекст
1. Вызвать `_load_documents` (уже реализован в `RagAgent`).  
2. Сериализовать каждый документ в markdown с заголовком, метаданными, оглавлением.  
3. Передать весь массив в `answer_with_full_context`.  
4. Добавить в `debug` список документов и их длину.

### 5.5. Сценарий 4 — RAG по выбранным документам
Аналогичен S1, но `document_ids` ограничивают поиск.  
Если векторный поиск падает → `_vector_search_unavailable_message`.

### 5.6. Сценарий 5 — уточнения
Агент использует `decision.clarifications`; если пусто, конструирует вопрос самостоятельно.

## 6. Работа с базой знаний
- **Подготовка данных**: конвертация `knowledge_base/train_data.csv` в markdown (одна запись = статья).  
- **Индексация**: тот же `DocumentVectorManager`, но отдельная коллекция Qdrant (например, `kb_chunks`) или отдельный `namespace` в payload (`{"source": "knowledge_base"}`).  
- **Метаданные**: `topic`, `jurisdiction`, `updated_at`.  
- **Поиск**: функция `search_general_kb` использует фильтр `source="knowledge_base"` и необязательные теги.  
- **Ответы**: при генерации агент явно помечает источник («Основывается на корпоративной базе знаний»), чтобы отличать от пользовательских документов.

## 7. Интеграции с внешними API

### 7.1. Банк России
- SOAP endpoint `https://cbr.ru/DailyInfoWebServ/DailyInfo.asmx`.  
- Операции:  
  - `GetCursOnDate` (курсы валют на дату),  
  - `GetCursDynamic` (диапазон дат),  
  - `KeyRate` (динамика ключевой ставки),  
  - `NewsInfo` (новости сервера).  
- Реализация: использовать `httpx.AsyncClient` + `xmltodict`/`zeep`. Обёртка `CentralBankClient` возвращает нормализованный JSON и кэширует ответы на 15 минут.  
- Валидация параметров: даты в `YYYY-MM-DD`, валюты — ISO 4217 или код ЦБ.  
- Исключения транслируем в дружелюбные сообщения и логируем.

### 7.2. Tavily Search
- HTTP `POST https://api.tavily.com/search` с JSON:  
  ```json
  {
    "api_key": "...",
    "query": "ключевая ставка ЦБ влияние на НДС",
    "max_results": 5,
    "search_depth": "advanced"
  }
  ```
- Ответ содержит массив `results` (title, url, content, score).  
- Обновления: требуем HTTPS, таймаут 8–10 секунд, exponential backoff при 5xx.  
- Источники в ответе форматируются как маркированный список ссылок.

## 8. Управление контекстом и формат ответа
- Каждая генерация получает инструкции из `_answer_format_instructions()` (`services/rag/agent.py`) и доп. указания в зависимости от сценария.  
- Контекст собирается как список секций: `General Facts`, `User Documents`, `Knowledge Base`, `External Data`.  
- Если использовались внешние API, обязательная сноска со ссылкой (например, `[Источник: cbr.ru]`).  
- LLM всегда отвечает на русском, использует Markdown (заголовок, краткий вывод, подробности, список источников).

## 9. Надёжность и наблюдаемость
- Логирование через `structlog`: `scenario_decision`, `query_expansion`, `external_call`.  
- Метрики: время поиска, количество чанков, успешность API-вызовов.  
- Кэширование:  
  - локальный TTL-кэш для ЦБ (курсы/ставки меняются 1 раз в день),  
  - кэш Tavily на 5 минут по (query, user_id).  
- Circuit breaker для внешних API, чтобы не блокировать ответы (при недоступности сообщаем пользователю и предлагаем альтернативы).

## 10. Безопасность и конфигурация
- Все ключи (`OPENROUTER_API_KEY`, Tavily API key) храним в Settings/Secrets, не логируем значения.  
- Qdrant URL задаётся через `QDRANT_URL`; для базы знаний можно использовать вторую коллекцию либо отдельный клиент.  
- Настройка порогов (`default_top_k`, `score_threshold`, `max_context_chars`) читается из env и прокидывается в конструктор `RagAgent`.

## 11. План внедрения
1. **Расширить `RagAgent`**: добавить под-интенты для сценария 2, функцию `route_general_intent`, регистрацию tool-функций.  
2. **Ввести knowledge base ingestion**: ETL из CSV → Markdown → Qdrant.  
3. **Имплементировать клиенты**: `CentralBankClient`, `TavilySearchClient`, `GeneralKnowledgeStore`.  
4. **Подключить tool-calls**: добавить описание функций в `OpenRouterChatClient.chat`.  
5. **Обновить тесты и документацию**: интеграционные тесты для каждой ветки сценариев + моков внешних API.  

Документ служит источником требований для команды, расширяя текущий дизайн и обеспечивая совместимость с уже существующими компонентами.

